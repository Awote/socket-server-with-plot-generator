# Socket Server with Plot Generator

[![Лицензия](https://img.shields.io/github/license/Awote/socket-server-with-plot-generator)](https://github.com/Awote/socket-server-with-plot-generator/blob/main/LICENSE)
[![Версия Python](https://img.shields.io/badge/Python-3.8%2B-blue.svg)](https://www.python.org/downloads/)

## Содержание

1. [Обзор](#обзор)
2. [Особенности](#особенности)
3. [Архитектура](#архитектура)
4. [Установка](#установка)
5. [Конфигурация](#конфигурация)
6. [Использование](#использование)
    - [Запуск сервера](#запуск-сервера)
    - [Отправка данных на сервер](#отправка-данных-на-сервер)
    - [Генерация графиков](#генерация-графиков)
7. [Структура проекта](#структура-проекта)
8. [Компоненты](#компоненты)
    - [Storage](#storage)
    - [Logger](#logger)
    - [Meter и MeterStorage](#meter-и-meterstorage)
    - [Сервер](#сервер)
9. [Тестирование](#тестирование)
10. [Вклад в проект](#вклад-в-проект)
11. [Лицензия](#лицензия)
12. [Контакты](#контакты)

---

## Обзор

**Socket Server with Plot Generator** — это серверное приложение на языке Python, предназначенное для приема, валидации, хранения и обработки данных от различных измерительных приборов (метров). Сервер регистрирует входящие измерения, вычисляет мощность на основе показаний напряжения и тока, а также генерирует графики для визуального анализа данных в реальном времени. Этот проект подходит для приложений, требующих мониторинга и визуализации данных от множества источников в режиме реального времени.

---

## Особенности

- **TCP Сервер**: Обработка нескольких клиентских подключений одновременно с использованием потоков.
- **Валидация данных**: Проверка поступающих данных на соответствие известным метрам, корректность единиц измерения и допустимые диапазоны значений.
- **Потокобезопасное хранилище**: Использование механизмов блокировки для управления доступом к данным при одновременных запросах.
- **Вычисление мощности**: Расчет мощности на основе последних показаний напряжения и тока.
- **Логирование**: Запись всех валидных измерений и вычисленных данных мощности.
- **Генерация графиков**: Создание графиков в реальном времени для визуализации тенденций данных мощности.
- **Масштабируемость**: Возможность обработки данных от множества метров и высокой частоты обновлений данных.

---

## Архитектура

Проект построен по модульной архитектуре, разделяя функциональность на различные компоненты:

- **Сервер**: Управляет подключениями клиентов и приемом данных.
- **Storage**: Обрабатывает валидацию данных, хранение и вычисление мощности.
- **Logger**: Регистрирует входящие измерения.
- **MeterStorage**: Управляет информацией о метрах и правилами валидации.
- **Генератор графиков**: (Предполагается, что часть проекта) Генерирует графики на основе хранимых данных.

![Схема Архитектуры](docs/architecture.png) *(Опционально: включите диаграмму архитектуры для лучшей визуализации)*

---

## Установка

### Предварительные требования

- **Python**: Версия 3.10 или выше. [Скачать Python](https://www.python.org/downloads/)
- **Git**: Для клонирования репозитория. [Скачать Git](https://git-scm.com/downloads)

### Шаги установки

1. **Клонирование репозитория:**

    ```bash
    git clone https://github.com/Awote/socket-server-with-plot-generator.git
    ```

2. **Переход в директорию проекта:**

    ```bash
    cd socket-server-with-plot-generator
    ```

3. **Создание виртуального окружения (опционально, но рекомендуется):**

    ```bash
    python -m venv venv
    ```

4. **Активация виртуального окружения:**

    - **Windows:**

        ```bash
        venv\Scripts\activate
        ```

    - **Unix/MacOS:**

        ```bash
        source venv/bin/activate
        ```

5. **Установка зависимостей:**

    ```bash
    pip install -r requirements.txt
    ```

---

## Использование

### Запуск сервера

После установки и настройки конфигурационных файлов можно запустить сервер следующей командой:

```bash
python server.py
```


### Отправка данных на сервер

Данные отправляются на сервер по протоколу TCP. Формат строки данных должен соответствовать следующему шаблону:

```
{IP_ADDR}\t{TIMESTAMP}\t{VALUE}\n
```

- **IP_ADDR**: IP-адрес метра.
- **TIMESTAMP**: Временная метка в формате `YYYY.MM.DD HH:MM:SS.ffffff`.
- **VALUE**: Значение измерения.

**Пример строки данных:**

```
192.168.1.10\t2024.04.27 14:23:55.123456\t230.5
```

## Компоненты

### Storage

Класс `Storage` отвечает за хранение измерительных данных, их валидацию и вычисление мощности. Он использует механизм блокировки для обеспечения потокобезопасности при доступе к данным.

**Основные методы:**

- `validate_and_store(ip, timestamp, value, unit)`: Валидирует входящие данные и сохраняет их в лог при корректности.
- `compute_power(max_time_diff=0.5)`: Вычисляет мощность на основе последних измерений напряжения и тока.

**Пример использования:**

```python
from core.storage import Storage
from core.meter_storage import MeterStorage
from core.logger import Logger

meter_storage = MeterStorage()
storage = Storage(log_name="power.log", meter_storage=meter_storage)
```

### Logger

Класс `Logger` отвечает за запись и хранение входящих измерений. Он разделяет записи по типам измерений (например, напряжение и ток).

**Основные методы:**

- `add_entry(ip, timestamp, value, unit)`: Добавляет новую запись в лог.

**Пример использования:**

```python
from core.logger import Logger

logger = Logger()
logger.add_entry("192.168.1.10", datetime.now(), 230.5, "V")
```

### Meter и MeterStorage

Класс `Meter` представляет собой измерительный прибор с его характеристиками.

**Класс `Meter`:**

- Атрибуты: `ip`, `unit`, `range_start`, `range_stop`.
- Методы: `is_unit_correct(unit)`, `check_value_in_range(value)`.

**Класс `MeterStorage`:**

Отвечает за управление коллекцией метров.

**Пример использования:**

```python
from core.meter import Meter
from core.meter_storage import MeterStorage

meter_storage = MeterStorage()
meter_storage.add_meter(Meter(ip="192.168.1.10", unit="V", range_start=0.0, range_stop=240.0))
```

### Сервер

Модуль сервера отвечает за управление клиентскими подключениями, приемом данных и передачей их в `Storage` для обработки.

**Основные функции:**

- `handle_client(client_socket, address, storage)`: Обрабатывает соединение с клиентом.
- `run_server(host, port, storage)`: Запускает сервер и слушает входящие подключения.

## Конфигурация

### Файл `ip_mapping.txt`

Перед запуском сервера необходимо создать файл `ip_mapping.txt` в корневой директории проекта. Этот файл содержит информацию о метрах и должен иметь следующую структуру:

IP_ADDRESS\tMIN_VALUE\tMAX_VALUE\tUNIT


**Пример содержимого `ip_mapping.txt`:**
```txt
10.0.0.1	0	110	В
10.0.0.2	0	0.5	А
10.0.0.3	0.2	1	А
10.0.0.4	1	5	А
10.0.0.5	3	10	А
```
## Запуск проекта

**Пример запуска сервера:**

```
python main.py
```

---

**Пример запуска клиента:**

```
python client.py
```

---